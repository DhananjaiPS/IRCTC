generator client {
  provider   = "prisma-client-js"
  output     = "./generated/client"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model User {
  clerkId       String    @unique
  id            String    @id @default(uuid())
  fullName      String
  email         String    @unique
  phone         String    @unique
  passwordHash  String?
  gender        Sex?
  dateOfBirth   DateTime?
  addressLine1  String?
  addressLine2  String?
  city          String?
  state         String?
  pincode       String?
  idType        IdCard?
  idNumber      String?   @unique
  kycVerified   Boolean   @default(false)
  walletBalance Float     @default(0.0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  bookings      Booking[]
  reviews       Review[]
}

model Station {
  id             String             @id @unique
  name           String
  fromBookings   Booking[]          @relation("FromStation")
  toBookings     Booking[]          @relation("ToStation")
  reviews        Review[]
  routes         Route[]
  fromAvail      SeatAvailability[] @relation("FromStationAvail")
  toAvail        SeatAvailability[] @relation("ToStationAvail")
  trainsAsDest   Train[]            @relation("DestinationStation")
  trainsAsSource Train[]            @relation("SourceStation")
}

model Route {
  id                BigInt    @id @default(autoincrement())
  trainId           BigInt
  stationId         String
  sequence          Int
  arrivalTime       DateTime? @db.Time(6)
  departureTime     DateTime? @db.Time(6)
  distanceFromStart Int
  station           Station   @relation(fields: [stationId], references: [id])
  train             Train     @relation(fields: [trainId], references: [id])
}

model Train {
  id                   BigInt  @id @default(autoincrement())
  trainNo              String  @unique
  name                 String
  type                 String
  sourceStationId      String
  destinationStationId String
  departureTime        String?
  arrivalTime          String?

  reviews            Review[]
  routes             Route[]
  destinationStation Station         @relation("DestinationStation", fields: [destinationStationId], references: [id])
  sourceStation      Station         @relation("SourceStation", fields: [sourceStationId], references: [id])
  schedules          TrainSchedule[]
}

model TrainSchedule {
  id                 BigInt              @id @default(autoincrement())
  trainId            BigInt
  status             ScheduleStatus      @default(RUNNING)
  daysOfWeek         Int[]
  endDate            DateTime?           @db.Date
  startDate          DateTime            @db.Date
  bookings           Booking[]
  coaches            Coach[]
  exceptions         ScheduleException[]
  seatAvailabilities SeatAvailability[]
  train              Train               @relation(fields: [trainId], references: [id])
}

model ScheduleException {
  id         BigInt        @id @default(autoincrement())
  scheduleId BigInt
  date       DateTime      @db.Date
  type       ExceptionType
  schedule   TrainSchedule @relation(fields: [scheduleId], references: [id])
}

model Coach {
  id                 BigInt             @id @default(autoincrement())
  scheduleId         BigInt
  coachType          String
  coachNumber        String
  totalSeats         Int
  schedule           TrainSchedule      @relation(fields: [scheduleId], references: [id])
  seats              Seat[]
  seatAvailabilities SeatAvailability[]
}

model Seat {
  id                 BigInt             @id @default(autoincrement())
  coachId            BigInt
  seatNo             String
  berthType          String
  passengers         Passenger[]
  coach              Coach              @relation(fields: [coachId], references: [id])
  seatAvailabilities SeatAvailability[]
}

model SeatAvailability {
  id            BigInt        @id @default(autoincrement())
  scheduleId    BigInt
  coachId       BigInt
  seatId        BigInt
  fromStationId String
  toStationId   String
  status        SeatStatus    @default(AVAILABLE)
  bookingId     BigInt?
  booking       Booking?      @relation(fields: [bookingId], references: [id])
  coach         Coach         @relation(fields: [coachId], references: [id])
  fromStation   Station       @relation("FromStationAvail", fields: [fromStationId], references: [id])
  schedule      TrainSchedule @relation(fields: [scheduleId], references: [id])
  seat          Seat          @relation(fields: [seatId], references: [id])
  toStation     Station       @relation("ToStationAvail", fields: [toStationId], references: [id])
}

model Booking {
  id                 BigInt             @id @default(autoincrement())
  pnr                String             @unique
  userId             String
  scheduleId         BigInt
  fromStationId      String
  toStationId        String
  status             BookingStatus      @default(BOOKED)
  bookedAt           DateTime           @default(now())
  fromStation        Station            @relation("FromStation", fields: [fromStationId], references: [id])
  schedule           TrainSchedule      @relation(fields: [scheduleId], references: [id])
  toStation          Station            @relation("ToStation", fields: [toStationId], references: [id])
  user               User               @relation(fields: [userId], references: [id])
  passengers         Passenger[]
  payment            Payment?
  seatAvailabilities SeatAvailability[]
}

model Passenger {
  id        BigInt          @id @default(autoincrement())
  bookingId BigInt
  name      String
  age       Int
  gender    String
  seatId    BigInt?
  status    PassengerStatus @default(WAITLISTED)
  booking   Booking         @relation(fields: [bookingId], references: [id])
  seat      Seat?           @relation(fields: [seatId], references: [id])
}

model Payment {
  id                   BigInt        @id @default(autoincrement())
  bookingId            BigInt        @unique
  amount               Float
  paymentMode          String
  gatewayTransactionId String
  status               PaymentStatus @default(PENDING)
  paymentTime          DateTime      @default(now())
  retryNumber          Int           @default(0)
  booking              Booking       @relation(fields: [bookingId], references: [id])
}

model Review {
  id        BigInt   @id @default(autoincrement())
  userId    String
  trainId   BigInt?
  stationId String?
  rating    Int
  title     String
  comment   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  station   Station? @relation(fields: [stationId], references: [id])
  train     Train?   @relation(fields: [trainId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

enum ScheduleStatus {
  RUNNING
  CANCELLED
}

enum SeatStatus {
  AVAILABLE
  BOOKED
  RAC
  WAITLISTED
}

enum BookingStatus {
  BOOKED
  CANCELLED
}

enum PassengerStatus {
  CONFIRMED
  RAC
  WAITLISTED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUND_INITIATED
  REFUND_SUCCESS
}

enum Sex {
  MALE
  FEMALE
  OTHER
}

enum IdCard {
  AADHAR
  PAN
  PASSPORT
}

enum ExceptionType {
  CANCEL
  ADD
}
